<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<title>index</title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1, user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<link rel="stylesheet" href="css/iconfont.css">
		<link rel="stylesheet" href="css/mui.min.css">
		<script src="js/mui.min.js"></script>
		<script src="js/app.js"></script>
		<script src="js/service.js"></script>
		<script src="js/update.js"></script>
		<!--<script type="text/javascript" src="js/common.js"></script>-->
		<!--<script type="text/javascript" src="js/comet4j-debug2.js"></script>-->
		<!--<script type="text/javascript" src="js/talk2.js"></script>-->
		<style>
			html,
			body {
				margin: 0;
				padding: 0;
				background-color: white;
			}
			header.mui-bar {
				display: none;
			}
			.mui-bar-nav~.mui-content {
				padding: 0;
			}
			.oa-contact-cell.mui-table .mui-table-cell {
				padding: 11px 0;
				vertical-align: middle;
			}
			.oa-contact-cell {
				position: relative;
				margin: -11px 0;
			}
			.oa-contact-avatar {
				width: 75px;
				padding-right: 10px !important;
			}
			.oa-contact-avatar img {
				border-radius: 50%;
			}
			.oa-contact-content {
				width: 100%;
			}
			.oa-contact-name {
				margin-right: 20px;
			}
			.oa-contact-name,
			.oa-contact-position {
				float: left;
			}
			.break {
				word-break: break-all;
				word-wrap: break-word;
				white-space: pre-line;
				margin-top: -20px;
			}
			.mui-control-content {
				background-color: white;
				min-height: 230px;
			}
			.mui-control-content .mui-loading {
				margin-top: 50px;
			}
			.my-denglu {
				font-size: 20px;
				font-weight: 800;
				color: plum;
				background-color: white;
				border: 1px white solid;
				padding: 8px 20px;
				border-radius: 8px;
			}
		</style>
	</head>

	<body>
		<div width="0" height="0" style="display: none;">

			<div id="statebar">
				连接状态：<span id="workStyle"></span>； 连接数量：
				<span id="connectorCount"></span>； 已用内存：
				<span id="usedMemory"></span>； 可用内存：
				<span id="freeMemory"></span>； 内存容量：
				<span id="totalMemory"></span>； 最大容量：
				<span id="maxMemory"></span>； 系统已运行：
				<span id="startup"></span>
			</div>

			<div id="logbox">
			</div>

			<div id="toolbar">
				请输入：
				<input maxlength="200" id="inputbox" class="inputbox" onkeypress="return onSendBoxEnter(event);" type="text"></input>
				<input type="button" class="button" onclick="send(inputbox.value);" value="回车发送"></input>
				<input type="button" class="button" onclick="rename();" value="改名"></input>
			</div>

			<div id="login">
				请输入昵称：
				<input type="text" class="inputbox" maxlength="50" id="loginName" onkeypress="return loginEnter(event);"></input>
				<input type="button" class="button" onclick="login();" value="确定"></input>
			</div>
			<div id="output">
				Push模块管理推送消息功能，可以实现在线、离线的消息推送，通过plus.push可获取推送消息管理对象。
			</div>
			<!--<iframe src="push.html" width="0" height="0"></iframe>-->
			<!--<iframe src="http://192.168.1.101:8080/appserver/comet4j/push.html" width="0" height="0"></iframe>-->
			<!--<iframe src="http://astroway.net:8090/appserver/comet4j/push.html" width="0" height="0"></iframe>-->
		</div>

		<div class="mui-content">

			<div>
				<img src="images/index/shouye2.png" style="width: 100%;" />
				<div style="float: right;margin-top: -100px;margin-right: 20px;z-index: 100;">
					<a id="denglu-btn-id" href="javascript:void(0);" class="mui-btn mui-btn-link" style="text-decoration:none;">
						<span class="my-denglu">登&nbsp;录</span>
						<!--<img src="images/index/login.png" style="width: 290px;" />-->
					</a>
				</div>
			</div>
			<div>
				<!-- background-image: url(images/index/circle.jpg);background-size: 140px 140px; -->
				<div id="pickDateBtn" style="padding-top:60px;background-repeat: no-repeat; width:140px;height:140px;
				position: absolute;top: 30px;text-align: center;left: 15px;font-weight: 800;color: saddlebrown;">

				</div>
			</div>

			<div id="slider" class="mui-slider" onclick="return false;">
				<!-- 课程 -->
				<div id="sliderSegmentedControl" class="mui-slider-indicator mui-segmented-control mui-segmented-control-inverted">

				</div>
				<div id="sliderProgressBar" class="mui-slider-progress-bar mui-col-xs-6"></div>
				<div class="mui-slider-group" id="out-content-id">
					<!-- 课程内容 -->
					<div id="item1mobile" class="mui-slider-item mui-control-content mui-active">
						<ul class="mui-table-view mui-table-view-striped mui-table-view-condensed">
						</ul>
					</div>
					<div id="item2mobile" class="mui-slider-item mui-control-content">
						<div class="mui-scroll">
							<div class="mui-loading">
								<div class="mui-spinner">
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div style="width: 100%;padding-bottom: 0px;padding: 10px;background-color: white;color: gray;">
				<div class="mui-text-center" style="font-size: 13px;">致力于打造移动学习平台</div>
				<div class="mui-text-center" style="font-size: 13px;">为您提供贴心的一站式服务</div>
				<div class="mui-text-center" style="font-size: 14px;margin-top: 5px;">宇威科技发展（青岛）有限公司版权所有</div>
			</div>
		</div>
		<script type="text/html" id="template-course-id">
			<a class="mui-control-item" data-id="{code}" href="#{code}">
				{name}
			</a>
		</script>
		<script type="text/html" id="template-content-id">
			<div id="{code}" class="mui-slider-item mui-control-content mui-active">
				<ul id="ui{code}" class="mui-table-view mui-table-view-striped mui-table-view-condensed">
				</ul>
			</div>
		</script>
		<script type="text/html" id="template-content-li-id">
			<li class="mui-table-view-cell">
				<div class="mui-slider-cell  my-leshi">
					<div class="oa-contact-cell mui-table my-leshi-div" data-lectures-id="{code}" data-title="{name}" data-lectures-name="会计基础">
						<div class="oa-contact-avatar mui-table-cell">
							<img src="images/zypx/ssx_iconjy.png" />
						</div>
						<div class="oa-contact-content mui-table-cell">
							<div class="mui-clearfix">
								<h4 class="oa-contact-name">乐试</h4>
								<span class="oa-contact-position mui-h6"></span>
							</div>
							<p class="oa-contact-email mui-h6 break">
								支持多平台同步、断电保障、智能监考
							</p>
						</div>
					</div>
				</div>
			</li>
		</script>
		<script type="text/javascript">
			/**
			 * 初始化菜单
			 * @param {Object} rows
			 */
			function initMenuDom(rows) {
					var scriptCourse = document.getElementById('template-course-id');
					var scriptContent = document.getElementById('template-content-id');
					//标题（会计基础、财经法规）
					var template = scriptCourse.innerHTML;
					//标题对应的每个内容
					var templateContent = scriptContent.innerHTML;
					var htmlStr = '';
					var htmlStrContent = '';
					for (var i = 0; i < rows.length; i++) {
						var row = rows[i];
						row.i = i + 1;
						htmlStr += render(template, row);
						htmlStrContent += render(templateContent, row);
					}
					var ct = document.getElementById('sliderSegmentedControl');
					var oc = document.getElementById('out-content-id');
					ct.innerHTML = htmlStr;
					oc.innerHTML = htmlStrContent;
					var scriptli = document.getElementById('template-content-li-id');
					//每个内容下的列表
					var templateli = scriptli.innerHTML;
					var htmlStrli = '';
					for (var k = 0; k < rows.length; k++) {
						var row = rows[k];
						htmlStrli = render(templateli, row);
						document.getElementById('ui' + row.code).innerHTML = htmlStrli;
					}
				}
				/**
				 * 点击乐试
				 */

			function leshiEvent() {
					mui(".my-leshi").on('tap', '.my-leshi-div', function() {
						var courseId = this.getAttribute('data-lectures-id');
						var title = this.getAttribute('data-title');
						var href = 'app/course.html';
						mui.openWindow({
							id: 'course-win-' + courseId,
							url: href,
							waiting: {
								autoShow: false
							},
							extras: {
								courseTitle: title,
								courseId: courseId,
							}
						});
					});
				}
				/**
				 * 设置考试时间
				 */

			function checkExamDistance() {
				var examdate = window.localStorage.getItem("exam_date");
				if (!examdate) {
					getExamDistance(); // 如果未设置了时间，则界面上显示”请设置考试时间“
					return;
				}
				examdate = new Date(parseInt(examdate));
				getExamDistance(examdate);
			}
			document.getElementById("pickDateBtn").addEventListener('tap', function() {
					var dDate = window.localStorage.getItem("exam_date");
					if (!dDate) {
						dDate = new Date();
					} else {
						dDate = new Date(parseInt(dDate));
					}
					//dDate.setFullYear(2014, 7, 16);
					var minDate = new Date();
					//minDate.setFullYear(2010, 0, 1);
					var maxDate = new Date();
					maxDate.setFullYear(dDate.getFullYear() + 1, 11, 31);
					plus.nativeUI.pickDate(function(e) {
						var d = e.date;
						window.localStorage.setItem("exam_date", d.getTime());
						getExamDistance(d);
					}, function(e) {
						var dDate = window.localStorage.getItem("exam_date");
						if (!dDate) {
							getExamDistance();
						} else {
							dDate = new Date(parseInt(dDate));
							getExamDistance(dDate);
						}
					}, {
						title: "请选择考试日期",
						date: dDate,
						minDate: minDate,
						maxDate: maxDate
					});
				})
				//计算距离考试时间

			function getExamDistance(examdate) {
					var handler = document.getElementById('pickDateBtn');
					if (!examdate) {
						handler.style.paddingTop = "65px";
						handler.innerHTML = "<div style='font-size:20px;text-align:center;'>请设置<br/>考试时间</div>";
						return;
					}
					var nowdate = new Date();
					if (examdate.getDate() == nowdate.getDate() && examdate.getFullYear() == nowdate.getFullYear() && examdate.getMonth() == nowdate.getMonth()) {
						handler.style.paddingTop = "74px";
						handler.innerHTML = "<div style='font-size:20px;text-align:center;'>祝您考试成功</div>";
					} else {
						var l = examdate.getTime() - nowdate.getTime();
						var d = Math.floor(l / (1000 * 60 * 60 * 24)) + 1;
						var dis = d;
						handler.style.paddingTop = "60px";
						handler.innerHTML = "<div style='font-size:25px;text-align:center;font-weight:800;'>" + dis + "天</div><div style='font-size:16px;text-align:center;'>距下次考试时间</div>";
					}
				}
				/**
				 * 启动自动登录
				 */

			function autoLogin() {
					var phone = window.localStorage.getItem("phone");
					var password = window.localStorage.getItem("password");
					if (phone == null || password == null) {
						window.localStorage.setItem('isAlreadyLogin', false);
						return;
					}
					mui.ajax(Routes.urls.user.login, {
						data: {
							username: phone,
							password: password
						},
						dataType: 'json', //服务器返回json格式数据
						type: 'post', //HTTP请求类型
						timeout: 10000, //超时时间设置为10秒；
						success: function(data) {
							if (data && data.success) {
								//记录用户登录信息
								window.localStorage.setItem('isAlreadyLogin', true);
								window.localStorage.setItem("phone", phone);
								window.localStorage.setItem("password", password);
								updateUserInfoToLocal();
							} else {
								window.localStorage.setItem('isAlreadyLogin', false);
								mui.toast(data.message);
							}
						}
					});
				}
				/**
				 * 注册登录事件
				 */

			function dengluEvent() {
					document.getElementById("denglu-btn-id").addEventListener('tap', function() {
						var loginSpan = this;
						var shouji = loginSpan.innerText;
						if (shouji == null) {
							return;
						}
						var yidenglu = shouji.indexOf("个");
						if (yidenglu >= 0) {
							mui.openWindow({
								id: 'personal-win',
								url: 'app/personal.html',
								waiting: {
									autoShow: false
								}
							})
						} else {
							mui.openWindow({
								id: 'login-win',
								url: 'app/login.html',
								waiting: {
									autoShow: false
								},
								extras: {
									sectionId: window.sectionId,
									gotoUrl: '../index.html',
									serviceObj: window.serviceObj
								}
							});
						}
					});
				}
				/**
				 * 初始化登录
				 */

			function initDenglu() {
					alreadyLogin(function() {
						var loginSpan = document.getElementById("denglu-btn-id");
						loginSpan.innerHTML = "<span style='font-size: 18px;font-weight: 800;color: white;border: 1px white solid;padding: 5px 5px;'>个人中心</span>";
					}, function() {
						var loginSpan = document.getElementById("denglu-btn-id");
						loginSpan.innerHTML = "<span class='my-denglu'>登&nbsp;录</span>";
					});
				}
				//首页返回键处理
				//处理逻辑：1秒内，连续两次按返回键，则退出应用；
			var first = null;
			mui.back = function() {
				//				//首次按键，提示‘再按一次退出应用’
				if (!first) {
					first = new Date().getTime();
					mui.toast('再按一次退出应用');
					setTimeout(function() {
						first = null;
					}, 1000);
				} else {
					if (new Date().getTime() - first < 1000) {
						plus.runtime.quit();
					}
				}
			};
			 //			window.domain = 'astroway.net';
			 //			function initPushMsg() {
			 //				JS.AJAX.post(URL + 'username.do', {}, function(result) {
			 //					if (result.responseText) {
			 //						window.__user_name = result.responseText;
			 ////						                  alert(window.__user_name)
			 //						document.getElementById("loginName").value = result.responseText;
			 //						login();
			 //						init();
			 //					}
			 //				});
			 //			}
			mui.init();
			mui.plusReady(function() {
				setTimeout(function() {
					initUpdate();
				}, 2000);
				checkExamDistance();
				//---------------------
				//查询所有课程，加载课程菜单
				queryAllCourse(function(rows) {
					initMenuDom(rows);
					leshiEvent();
				});
				dengluEvent();
				initDenglu();
				//				initPushMsg();
				var wv = plus.webview;
				wv.close('personal-win');
				wv.close('login-win');
				/**
				 * 个推的透传，使用key--value对，会重写msg中的title和content
				 * title:正确，content：错误，则title是正确的信息，content则为json格式的数据
				 * title:错误，content：正确，则title为“个推”，content是正确的信息
				 */
				plus.push.addEventListener("receive", function(msg) {
					try {
						//用户推送输入错误，则不再保存消息
						var contents = msg.content;
						var contentJson = JSON.parse(contents);
					} catch (e) {
						//用户推送正确的信息，保存信息到消息中心
						saveMessage(msg);
						if (msg) {
							mui.openWindow({
								id: "msg-center-win",
								url: "app/msg-center.html",
								waiting: {
									autoShow: true
								}
							});
						}
					}
				});
			});
		</script>
	</body>

</html>